---
interface Comment {
  id: string;
  postSlug: string;
  author: string;
  website?: string;
  content: string;
  date: string;
  approved: boolean;
}

interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;

// 从public目录读取评论
let comments: Comment[] = [];
try {
  const response = await fetch(`${Astro.site}comments/comments.json`);
  if (response.ok) {
    const allComments = await response.json();
    comments = allComments
      .filter((c: Comment) => c.postSlug === postSlug && c.approved)
      .sort((a: Comment, b: Comment) =>
        new Date(b.date).getTime() - new Date(a.date).getTime()
      );
  }
} catch (error) {
  // 开发环境本地读取
  try {
    const fs = await import('fs/promises');
    const path = await import('path');
    const filePath = path.join(process.cwd(), 'public/comments/comments.json');
    const data = await fs.readFile(filePath, 'utf-8');
    const allComments = JSON.parse(data);
    comments = allComments
      .filter((c: Comment) => c.postSlug === postSlug && c.approved)
      .sort((a: Comment, b: Comment) =>
        new Date(b.date).getTime() - new Date(a.date).getTime()
      );
  } catch (e) {
    console.log('无法加载评论:', e);
  }
}
---

<section class="comments-section">
  <h2 class="comments-title">评论 ({comments.length})</h2>

  <!-- 评论列表 -->
  {comments.length > 0 ? (
    <div class="comments-list">
      {comments.map(comment => (
        <div class="comment-item">
          <div class="comment-header">
            {comment.website ? (
              <a href={comment.website} class="comment-author" target="_blank" rel="noopener noreferrer">
                {comment.author}
              </a>
            ) : (
              <span class="comment-author">{comment.author}</span>
            )}
            <time class="comment-date" datetime={comment.date}>
              {new Date(comment.date).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </time>
          </div>
          <div class="comment-content">{comment.content}</div>
        </div>
      ))}
    </div>
  ) : (
    <p class="no-comments">还没有评论，来留下第一条评论吧！</p>
  )}

  <!-- 评论表单说明 -->
  <div class="comment-form-info">
    <h3>如何添加评论？</h3>
    <p>本博客使用基于文件的评论系统，提交评论需要以下步骤：</p>
    <ol>
      <li>填写下方表单</li>
      <li>点击"生成评论"按钮</li>
      <li>复制生成的评论内容</li>
      <li>通过 <a href="https://github.com/x1ngg3/blog/issues/new" target="_blank" rel="noopener noreferrer">GitHub Issue</a> 提交</li>
      <li>我会审核后添加到评论文件中</li>
    </ol>
  </div>

  <!-- 评论表单 -->
  <form class="comment-form" id="commentForm">
    <input type="hidden" id="postSlug" value={postSlug} />

    <div class="form-group">
      <label for="author">你的名字 *</label>
      <input
        type="text"
        id="author"
        name="author"
        required
        placeholder="输入你的名字"
      />
    </div>

    <div class="form-group">
      <label for="website">你的网站（可选）</label>
      <input
        type="url"
        id="website"
        name="website"
        placeholder="https://your-website.com"
      />
    </div>

    <div class="form-group">
      <label for="content">评论内容 *</label>
      <textarea
        id="content"
        name="content"
        required
        rows="5"
        placeholder="写下你的想法..."
      ></textarea>
    </div>

    <button type="button" class="submit-button" onclick="generateComment()">
      生成评论
    </button>
  </form>

  <!-- 生成的评论 JSON -->
  <div id="generatedComment" class="generated-comment" style="display: none;">
    <h3>生成的评论内容</h3>
    <p>请复制以下内容，并通过 <a href="https://github.com/x1ngg3/blog/issues/new" target="_blank">GitHub Issue</a> 提交：</p>
    <pre id="commentJson"></pre>
    <button type="button" class="copy-button" onclick="copyComment()">复制评论</button>
  </div>
</section>

<script is:inline>
function generateComment() {
  const form = document.getElementById('commentForm');
  const postSlug = document.getElementById('postSlug').value;
  const author = document.getElementById('author').value.trim();
  const website = document.getElementById('website').value.trim();
  const content = document.getElementById('content').value.trim();

  if (!author || !content) {
    alert('请填写名字和评论内容');
    return;
  }

  const comment = {
    id: Date.now().toString(),
    postSlug: postSlug,
    author: author,
    website: website || undefined,
    content: content,
    date: new Date().toISOString(),
    approved: false
  };

  // 移除 undefined 字段
  const cleanComment = JSON.parse(JSON.stringify(comment));

  const commentJson = JSON.stringify(cleanComment, null, 2);
  document.getElementById('commentJson').textContent = commentJson;
  document.getElementById('generatedComment').style.display = 'block';
  document.getElementById('generatedComment').scrollIntoView({ behavior: 'smooth' });
}

function copyComment() {
  const commentJson = document.getElementById('commentJson').textContent;
  navigator.clipboard.writeText(commentJson).then(() => {
    alert('评论已复制到剪贴板！请前往 GitHub Issue 提交');
  }).catch(() => {
    alert('复制失败，请手动选择并复制');
  });
}
</script>

<style>
  .comments-section {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 2px solid var(--color-border);
  }

  .comments-title {
    font-size: 2rem;
    margin-bottom: 2rem;
    color: var(--color-text);
  }

  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .comment-item {
    padding: 1.5rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    border-left: 4px solid var(--color-primary);
  }

  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .comment-author {
    font-weight: 600;
    color: var(--color-primary);
    text-decoration: none;
  }

  .comment-author:hover {
    text-decoration: underline;
  }

  .comment-date {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .comment-content {
    color: var(--color-text);
    line-height: 1.6;
    white-space: pre-wrap;
  }

  .no-comments {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
    background: var(--color-bg-secondary);
    border-radius: 12px;
    margin-bottom: 3rem;
  }

  .comment-form-info {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #fffbeb;
    border: 1px solid #fbbf24;
    border-radius: 8px;
  }

  .comment-form-info h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #92400e;
  }

  .comment-form-info p {
    margin: 0.5rem 0;
    color: #78350f;
  }

  .comment-form-info ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
    color: #78350f;
  }

  .comment-form-info li {
    margin: 0.5rem 0;
  }

  .comment-form-info a {
    color: #2563eb;
    text-decoration: underline;
  }

  .comment-form {
    background: var(--color-bg-secondary);
    padding: 2rem;
    border-radius: 12px;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--color-text);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-family: inherit;
    font-size: 1rem;
    background: var(--color-bg);
    color: var(--color-text);
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
  }

  .submit-button,
  .copy-button {
    background: var(--color-primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-button:hover,
  .copy-button:hover {
    background: var(--color-primary-hover);
  }

  .generated-comment {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f0fdf4;
    border: 1px solid #22c55e;
    border-radius: 8px;
  }

  .generated-comment h3 {
    margin-top: 0;
    color: #166534;
  }

  .generated-comment p {
    color: #166534;
    margin-bottom: 1rem;
  }

  .generated-comment pre {
    background: var(--color-bg);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .copy-button {
    background: #22c55e;
  }

  .copy-button:hover {
    background: #16a34a;
  }

  @media (max-width: 768px) {
    .comments-section {
      padding-top: 2rem;
    }

    .comment-form {
      padding: 1.5rem;
    }

    .comment-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
