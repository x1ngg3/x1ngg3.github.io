---
title: Claude Code 工作原理详解
date: 2024-01-27
author: x1ngg3
description: 深入理解 Claude Code 的智能代理循环、内置工具以及如何与你的项目交互。
---

Claude Code 是一个运行在终端中的智能代理助手。虽然它擅长编程，但它可以帮助你完成从命令行可以做的任何事情：编写文档、运行构建、搜索文件、研究主题等等。

本指南涵盖核心架构、内置功能，以及有效使用 Claude Code 的技巧。

## 智能代理循环

当你给 Claude 一个任务时，它会经历三个阶段：**收集上下文**、**采取行动**和**验证结果**。这些阶段相互交织。Claude 在整个过程中使用工具，无论是搜索文件以理解你的代码、编辑以进行更改，还是运行测试以检查其工作。

循环会根据你的要求进行调整。关于代码库的问题可能只需要收集上下文。修复 bug 会重复经历所有三个阶段。重构可能涉及大量验证。Claude 根据从上一步学到的内容决定每一步需要什么，将数十个操作链接在一起，并沿途纠正方向。

你也是这个循环的一部分。你可以随时中断以引导 Claude 朝不同的方向发展、提供额外的上下文或要求它尝试不同的方法。Claude 自主工作，但对你的输入保持响应。

### 模型

Claude Code 使用 Claude 模型来理解你的代码并推理任务。Claude 可以阅读任何语言的代码，理解组件如何连接，并找出需要更改什么才能实现你的目标。对于复杂的任务，它会将工作分解为步骤，执行它们，并根据学到的内容进行调整。

可以使用多个具有不同权衡的模型。Sonnet 可以很好地处理大多数编码任务。Opus 为复杂的架构决策提供更强的推理能力。在会话期间使用 `/model` 切换或使用 `claude --model <name>` 启动。

### 工具

工具是使 Claude Code 具有代理性的关键。没有工具，Claude 只能用文本响应。有了工具，Claude 可以行动：阅读你的代码、编辑文件、运行命令、搜索网络以及与外部服务交互。每次工具使用都会返回信息，这些信息反馈到循环中，为 Claude 的下一个决策提供信息。

内置工具通常分为四类，每类代表不同类型的代理能力。

#### 文件操作
- 读取文件
- 编辑代码
- 创建新文件
- 重命名和重组

#### 搜索
- 按模式查找文件
- 使用正则表达式搜索内容
- 探索代码库

#### 执行
- 运行 shell 命令
- 启动服务器
- 运行测试
- 使用 git

#### Web
- 搜索网络
- 获取文档
- 查找错误消息

这些是主要功能。Claude 还有用于生成子代理、向你提问和其他编排任务的工具。

Claude 根据你的提示和它在过程中学到的内容选择使用哪些工具。当你说"修复失败的测试"时，Claude 可能会：

1. 运行测试套件以查看失败的内容
2. 阅读错误输出
3. 搜索相关源文件
4. 阅读这些文件以理解代码
5. 编辑文件以修复问题
6. 再次运行测试以验证

每次工具使用都为 Claude 提供了新信息，为下一步提供信息。这就是智能代理循环的实际应用。

## Claude 可以访问什么

当你在目录中运行 `claude` 时，Claude Code 可以访问：

- **你的项目。** 目录和子目录中的文件，以及在你允许的情况下其他地方的文件。
- **你的终端。** 你可以运行的任何命令：构建工具、git、包管理器、系统实用程序、脚本。如果你可以从命令行执行它，Claude 也可以。
- **你的 git 状态。** 当前分支、未提交的更改和最近的提交历史。
- **你的 CLAUDE.md。** 一个 markdown 文件，你在其中存储 Claude 每次会话都应该知道的项目特定指令、约定和上下文。
- **你配置的扩展。** 用于外部服务的 MCP 服务器、用于工作流的技能、用于委托工作的子代理，以及用于浏览器交互的 Chrome 中的 Claude。

因为 Claude 看到了你的整个项目，它可以跨项目工作。当你要求 Claude "修复身份验证 bug" 时，它会搜索相关文件，阅读多个文件以理解上下文，在它们之间进行协调编辑，运行测试以验证修复，并在你要求时提交更改。这与只能看到当前文件的内联代码助手不同。

## 与会话一起工作

Claude Code 在你工作时在本地保存你的对话。每条消息、工具使用和结果都被存储，这使得能够倒回、恢复和分叉会话。在 Claude 进行代码更改之前，它还会快照受影响的文件，以便你可以根据需要恢复。

**会话是临时的。** 与 claude.ai 不同，Claude Code 在会话之间没有持久记忆。每个新会话都是全新开始。Claude 不会随着时间的推移"学习"你的偏好或记住你上周做了什么。如果你希望 Claude 跨会话知道某些内容，请将其放入你的 CLAUDE.md 中。

### 跨分支工作

每个 Claude Code 对话都是一个与当前目录绑定的会话。当你恢复时，你只会看到该目录中的会话。

Claude 看到你当前分支的文件。当你切换分支时，Claude 看到新分支的文件，但你的对话历史保持不变。即使在切换后，Claude 也会记住你讨论的内容。

由于会话与目录绑定，你可以通过使用 git worktrees 运行并行的 Claude 会话，它为各个分支创建单独的目录。

## 有效使用 Claude Code

这些技巧可以帮助你从 Claude Code 获得更好的结果。

### 向 Claude Code 寻求帮助

Claude Code 可以教你如何使用它。提出诸如"如何设置钩子？"或"构建我的 CLAUDE.md 的最佳方式是什么？"之类的问题，Claude 会解释。

内置命令也会引导你完成设置：

- `/init` 引导你为项目创建 CLAUDE.md
- `/agents` 帮助你配置自定义子代理
- `/doctor` 诊断安装的常见问题

### 这是一次对话

Claude Code 是对话式的。你不需要完美的提示。从你想要的开始，然后完善：

```
> 修复登录 bug

[Claude 调查，尝试某事]

> 那不太对。问题在于会话处理。

[Claude 调整方法]
```

当第一次尝试不对时，你不必重新开始。你可以迭代。

#### 中断和引导

你可以随时中断 Claude。如果它走错了路，只需输入你的更正并按 Enter。Claude 会停止它正在做的事情，并根据你的输入调整其方法。你不必等待它完成或重新开始。

### 预先具体说明

你的初始提示越精确，你需要的更正就越少。引用特定文件，提及约束，并指出示例模式。

```
> 对于持有过期卡的用户，结账流程已损坏。
> 检查 src/payments/ 以查找问题，特别是令牌刷新。
> 首先编写一个失败的测试，然后修复它。
```

像"修复登录 bug"这样的模糊提示可以工作，但你会花更多时间进行引导。像上面这样的具体提示通常在第一次尝试时就能成功。

### 给 Claude 一些可以验证的东西

当 Claude 可以检查自己的工作时，它表现得更好。包括测试用例、粘贴预期 UI 的屏幕截图或定义你想要的输出。

```
> 实现 validateEmail。测试用例：'user@example.com' → true,
> 'invalid' → false, 'user@.com' → false。之后运行测试。
```

对于视觉工作，粘贴设计的屏幕截图，并要求 Claude 将其实现与之进行比较。

### 在实施前探索

对于复杂的问题，将研究与编码分开。使用计划模式（`Shift+Tab` 两次）首先分析代码库：

```
> 阅读 src/auth/ 并了解我们如何处理会话。
> 然后创建一个添加 OAuth 支持的计划。
```

审查计划，通过对话完善它，然后让 Claude 实施。这种两阶段方法比直接跳到代码产生更好的结果。

### 委托，不要命令

想象委托给一位有能力的同事。提供上下文和方向，然后相信 Claude 会弄清楚细节：

```
> 对于持有过期卡的用户，结账流程已损坏。
> 相关代码在 src/payments/ 中。你能调查并修复它吗？
```

你不需要指定要阅读哪些文件或运行哪些命令。Claude 会弄清楚。

## 总结

Claude Code 通过智能代理循环、丰富的工具集和对话式交互，为开发者提供了强大的编程辅助能力。理解其工作原理，掌握有效的使用技巧，可以大幅提升你的开发效率。
